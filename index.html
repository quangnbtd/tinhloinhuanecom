<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Cụ Tính Lợi Nhuận Shopee Theo Ngành Hàng - Vũ Quang Ecommerce</title>
    <style>
        /* --- CSS Styles remain largely the same as V2 --- */
        /* Minor adjustments might be needed for the new select fields */
         :root {
            --primary-color: #ee4d2d;
            --primary-color-dark: #d73210;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --text-color: #333;
            --text-color-light: #555;
            --text-color-footer: #6c757d;
            --note-color: #777;
            --border-color: #ddd;
            --background-color: #f8f9fa;
            --white: #fff;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background-color: var(--white);
            padding: 30px 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-width: 650px;
            width: 100%;
            margin-top: 30px;
            margin-bottom: 30px;
            flex-shrink: 0;
        }

        h1 { text-align: center; color: var(--primary-color); margin-bottom: 15px; font-size: 1.8em; }
        .luu-y { text-align: center; font-size: 0.9em; color: var(--text-color-light); margin-bottom: 25px; background-color: #e9f5e9; padding: 8px 12px; border-radius: 4px; border: 1px solid #c8e6c9; }

        fieldset { border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px 20px 20px 20px; margin-bottom: 25px; background-color: var(--white); }
        legend { padding: 0 10px; font-weight: 600; color: var(--primary-color); font-size: 1.1em; }

        .form-group { margin-bottom: 18px; }
        .form-group:last-child { margin-bottom: 0; }

        label { display: block; margin-bottom: 5px; /* Increased margin slightly */ font-weight: 600; color: var(--text-color-light); font-size: 0.95em; }
        .form-group small { display: block; font-size: 0.8em; color: var(--note-color); margin-top: -3px; /* Adjust spacing after label */ margin-bottom: 8px; line-height: 1.3; }

        input[type="number"], input[type="text"], select { /* Added select styling */
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            background-color: var(--white); /* Ensure select has white background */
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(238, 77, 45, 0.15);
        }
        input[type="number"]:disabled, select:disabled {
             background-color: #eee;
             cursor: not-allowed;
             opacity: 0.7;
         }
        /* Style for the read-only fee display */
        #phiCoDinhDisplay {
            font-weight: bold;
            color: var(--primary-color);
            padding: 5px 0;
        }


        input[type="checkbox"] { margin-right: 8px; vertical-align: middle; width: 16px; height: 16px; accent-color: var(--primary-color); }
        .checkbox-label { display: inline-flex; align-items: center; font-weight: normal; color: var(--text-color); cursor: pointer; user-select: none; margin-bottom: 0; }
        .checkbox-label span { line-height: 1.2; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; padding-top: 10px; }

        .input-row { display: flex; gap: 15px; align-items: flex-start; /* Align items top */ }
        .input-row .form-group { flex: 1; margin-bottom: 0; }

        button { display: block; width: 100%; padding: 14px; background-color: var(--primary-color); color: var(--white); border: none; border-radius: 6px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed) ease, transform 0.1s ease; margin-top: 15px; }
        button:hover { background-color: var(--primary-color-dark); }
        button:active { transform: scale(0.98); }

        #ketQuaTrucTiep { margin-top: 25px; padding: 15px 20px; border-radius: var(--border-radius); background-color: var(--background-color); border: 1px solid var(--border-color); min-height: 2.5em; text-align: center; font-size: 1.1em; line-height: 1.5; }
        #ketQuaTrucTiep.result-positive { background-color: #f0fff4; border-color: var(--success-color); }
        #ketQuaTrucTiep.result-negative { background-color: #fff5f5; border-color: var(--error-color); }
        #ketQuaTrucTiep.result-zero { background-color: #fffcf0; border-color: var(--warning-color); }

        .positive { color: var(--success-color); font-weight: 700; }
        .negative { color: var(--error-color); font-weight: 700; }
        .zero { color: var(--warning-color); font-weight: 700; }

        .error { color: var(--error-color); font-size: 0.85em; margin-top: 5px; min-height: 1.2em; }

        footer { text-align: center; padding: 20px 15px; margin-top: auto; width: 100%; font-size: 0.9em; color: var(--text-color-footer); }
        footer p { margin-bottom: 8px; }
        footer a { color: var(--primary-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-color-dark); text-decoration: underline; }
    </style>
</head>
<body>

<div class="container">
    <h1>Công Cụ Tính Lợi Nhuận Shopee Theo Ngành Hàng</h1>
    <p class="luu-y">Nhập đầy đủ thông tin giá và các loại chi phí dự kiến để ước tính lợi nhuận.</p>

    <!-- === THÔNG TIN CƠ BẢN === -->
    <fieldset>
        <legend>Thông Tin Sản Phẩm</legend>
        <div class="input-row">
             <div class="form-group">
                <label for="giaNhap">Giá Nhập (VNĐ)</label>
                <input type="number" id="giaNhap" placeholder="Giá vốn sản phẩm" required>
                <div class="error" id="errorGiaNhap"></div>
            </div>
            <div class="form-group">
                <label for="giaBan">Giá Bán Shopee (VNĐ)</label>
                <input type="number" id="giaBan" placeholder="Giá hiển thị trên Shopee" required>
                <div class="error" id="errorGiaBan"></div>
            </div>
        </div>
    </fieldset>

    <!-- === PHÍ SÀN (Tự động & Nhập liệu) === -->
    <fieldset>
         <legend>Phí Sàn</legend>
         <!-- Category Selection for Fixed Fee -->
         <div class="input-row">
              <div class="form-group">
                <label for="nganhHangL1">Ngành hàng Cấp 1</label>
                <select id="nganhHangL1" required>
                    <option value="">-- Chọn Cấp 1 --</option>
                </select>
                <div class="error" id="errorNganhHangL1"></div>
              </div>
               <div class="form-group">
                <label for="nganhHangL2">Ngành hàng Cấp 2</label>
                <select id="nganhHangL2" required disabled>
                    <option value="">-- Chọn Cấp 2 --</option>
                </select>
                 <div class="error" id="errorNganhHangL2"></div>
              </div>
         </div>
          <div class="form-group">
              <label>Phí Cố Định (Hoa hồng) tự động:</label>
              <div id="phiCoDinhDisplay" style="padding-top: 5px;">Chưa chọn ngành hàng</div>
          </div>
         <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
         <!-- Other Platform Fees (Manual Input) -->
         <div class="input-row">
            <div class="form-group">
                <label for="tyLePhiThanhToan">% Phí Thanh Toán</label>
                <small>Phí giao dịch qua cổng TT.</small>
                <input type="number" id="tyLePhiThanhToan" placeholder="VD: 4" step="0.1" value="4.0" required>
                <div class="error" id="errorPhiThanhToan"></div>
            </div>
            <div class="form-group">
                <label for="tyLeThue">% Thuế</label>
                 <small>Thuế TNCN/TNDN (nếu có).</small>
                <input type="number" id="tyLeThue" placeholder="VD: 1.5" step="0.1" value="1.5" required>
                <div class="error" id="errorThue"></div>
            </div>
         </div>
         <div class="form-group">
             <label class="checkbox-label" for="isMall">
                 <input type="checkbox" id="isMall">
                 <span>Gian hàng là Shopee Mall?</span>
             </label>
         </div>
          <div class="form-group">
                <label for="tyLePhiMall">% Phí Shopee Mall (Nếu là Mall)</label>
                 <small>Phí dịch vụ Mall cộng thêm (chỉ nhập nếu tick ở trên).</small>
                <input type="number" id="tyLePhiMall" placeholder="VD: 3" step="0.1" value="3.0" required disabled>
                <div class="error" id="errorPhiMall"></div>
         </div>
    </fieldset>


    <!-- === CHI PHÍ MARKETING (% trên Giá Bán) === -->
    <fieldset>
         <legend>Chi Phí Marketing (% trên Giá Bán)</legend>
         <div class="input-row">
             <div class="form-group">
                <label for="phanTramQuangCao">% Quảng cáo Shopee</label>
                <small>Đấu thầu, Khám phá... (VAT 10% sẽ được tính thêm).</small>
                <input type="number" id="phanTramQuangCao" placeholder="VD: 18" step="0.1" value="0" required>
                <div class="error" id="errorQuangCao"></div>
            </div>
            <div class="form-group">
                <label for="phanTramAffiliate">% Affiliate / TTLK</label>
                <small>Trả cho KOLs, KOCs...</small>
                <input type="number" id="phanTramAffiliate" placeholder="VD: 15" step="0.1" value="0" required>
                <div class="error" id="errorAffiliate"></div>
            </div>
         </div>
         <div class="input-row">
             <div class="form-group">
                <label for="phanTramVoucher">% Voucher / KM</label>
                <small>Voucher NBH, Flash Sale...</small>
                <input type="number" id="phanTramVoucher" placeholder="VD: 5" step="0.1" value="0" required>
                <div class="error" id="errorVoucher"></div>
            </div>
            <div class="form-group">
                <label for="phanTramMktKhac">% Chi phí MKT khác</label>
                <small>Booking live, content...</small>
                <input type="number" id="phanTramMktKhac" placeholder="VD: 3" step="0.1" value="0" required>
                <div class="error" id="errorMktKhac"></div>
            </div>
         </div>
    </fieldset>

     <!-- === CHI PHÍ VẬN HÀNH & RỦI RO (% trên Giá Bán) === -->
    <fieldset>
        <legend>Vận Hành & Rủi Ro (% trên Giá Bán)</legend>
        <div class="input-row">
             <div class="form-group">
                <label for="tyLeVanHanh">% Phí Vận Hành</label>
                <small>Kho bãi, nhân sự, điện nước...</small>
                <input type="number" id="tyLeVanHanh" placeholder="VD: 5" step="0.1" value="0" required>
                <div class="error" id="errorVanHanh"></div>
            </div>
            <div class="form-group">
                <label for="tyLeBatThuong">% Phí Bất Thường</label>
                <small>Dự phòng rủi ro, hỏng hóc...</small>
                <input type="number" id="tyLeBatThuong" placeholder="VD: 2" step="0.1" value="0" required>
                <div class="error" id="errorBatThuong"></div>
            </div>
        </div>
    </fieldset>

    <!-- === CHƯƠNG TRÌNH SHOPEE (Checkbox) === -->
    <fieldset>
        <legend>Chương Trình Shopee</legend>
        <div class="checkbox-group">
            <div class="form-group">
                <label class="checkbox-label" for="useFreeshipXtra">
                    <input type="checkbox" id="useFreeshipXtra">
                    <span>Tham gia Freeship Xtra?</span>
                </label>
                <small>(Phí ~8%, tối đa 30.000đ/sp - Kiểm tra biểu phí mới nhất)</small>
            </div>
             <div class="form-group">
                <label class="checkbox-label" for="useVoucherXtra">
                    <input type="checkbox" id="useVoucherXtra">
                    <span>Tham gia Voucher Xtra?</span>
                </label>
                 <small>(Phí ~5%, tối đa 20.000đ/sp - Kiểm tra biểu phí mới nhất)</small>
            </div>
        </div>
    </fieldset>


     <!-- === CHI PHÍ KHÁC (Cố định / đơn) === -->
    <fieldset>
        <legend>Chi Phí Khác (VNĐ / đơn)</legend>
         <div class="input-row">
             <div class="form-group">
                <label for="chiPhiDongGoi">Đóng gói / Xử lý</label>
                <small>Hộp, băng keo, in ấn...</small>
                <input type="number" id="chiPhiDongGoi" placeholder="VD: 2000" step="100" value="0" required>
                <div class="error" id="errorDongGoi"></div>
            </div>
             <div class="form-group">
                <label for="chiPhiMktCoDinh">MKT cố định</label>
                 <small>Quà tặng, sample...</small>
                <input type="number" id="chiPhiMktCoDinh" placeholder="VD: 1000" step="100" value="0" required>
                <div class="error" id="errorMktCoDinh"></div>
            </div>
         </div>
    </fieldset>

      <!-- === CHI PHÍ HOÀN HÀNG === -->
    <fieldset>
        <legend>Chi Phí Hoàn Hàng (Ước tính)</legend>
         <div class="input-row">
             <div class="form-group">
                <label for="tyLeHoan">% Tỷ lệ hoàn hàng</label>
                <small>Tỷ lệ đơn bị hoàn dự kiến.</small>
                <input type="number" id="tyLeHoan" placeholder="VD: 2" step="0.1" value="0" required>
                <div class="error" id="errorTyLeHoan"></div>
            </div>
             <div class="form-group">
                <label for="chiPhiXuLyHoan">Phí xử lý / đơn hoàn</label>
                 <small>Phí VC chiều về, hao hụt...</small>
                <input type="number" id="chiPhiXuLyHoan" placeholder="VD: 15000" step="100" value="0" required>
                <div class="error" id="errorXuLyHoan"></div>
            </div>
         </div>
    </fieldset>

    <button id="tinhToanBtn">Tính Lợi Nhuận</button>

    <!-- === RESULT AREA === -->
    <div id="ketQuaTrucTiep">
        <!-- Kết quả sẽ được hiển thị ở đây -->
    </div>

</div>

<footer>
    <p>Công cụ được phát triển bởi <strong>Vũ Quang Ecommerce</strong>.</p>
    <p>
        Kết nối hợp tác: <a href="tel:0386473757">0386 473 757</a> |
        Website: <a href="https://www.vuthanhquang.com/" target="_blank" rel="noopener noreferrer">vuthanhquang.com</a>
    </p>
</footer>

<script defer>
    // --- Category Data ---
    const categoryData = [
        { l1: "Máy tính & Laptop", l2: "Máy Tính Bàn", fee: 1.5 }, { l1: "Máy tính & Laptop", l2: "Laptop", fee: 1.5 }, { l1: "Máy tính & Laptop", l2: "Màn Hình", fee: 1.5 },
        { l1: "Điện Thoại & Phụ Kiện", l2: "Điện thoại", fee: 1.5 }, { l1: "Điện Thoại & Phụ Kiện", l2: "Máy tính bảng", fee: 1.5 },
        { l1: "Thiết Bị Âm Thanh", l2: "Amply và đầu chỉnh âm", fee: 7.0 }, { l1: "Thiết Bị Âm Thanh", l2: "Cáp âm thanh/ video & Đầu chuyển", fee: 7.0 }, { l1: "Thiết Bị Âm Thanh", l2: "Tai nghe nhét tai & chụp tai", fee: 7.0 }, { l1: "Thiết Bị Âm Thanh", l2: "Dàn âm thanh", fee: 7.0 }, { l1: "Thiết Bị Âm Thanh", l2: "Máy nghe nhạc", fee: 7.0 }, { l1: "Thiết Bị Âm Thanh", l2: "Micro thu âm", fee: 7.0 },
        { l1: "Cameras & Flycam", l2: "Phụ kiện máy ảnh", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Phụ kiện chăm sóc máy ảnh", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Máy ảnh", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Phụ kiện Flycam", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Flycam", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Phụ kiện ống kính", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Ống kính", fee: 7.0 }, { l1: "Cameras & Flycam", l2: "Camera giám sát", fee: 7.0 },
        { l1: "Máy tính & Laptop", l2: "Thiết Bị Lưu Trữ", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Linh Kiện Máy Tính", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Chuột & Bàn Phím", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Thiết Bị Mạng", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Thiết Bị Văn Phòng", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Phụ Kiện Máy Tính", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Máy In & Máy Scan", fee: 7.0 }, { l1: "Máy tính & Laptop", l2: "Phần Mềm", fee: 7.0 },
        { l1: "Gaming & Console", l2: "Phụ kiện console", fee: 7.0 }, { l1: "Gaming & Console", l2: "Máy chơi game", fee: 7.0 }, { l1: "Gaming & Console", l2: "Video Games", fee: 7.0 },
        { l1: "Thiết Bị Điện Gia Dụng", l2: "Pin", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Mạch điện & Phụ tùng", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Đồ gia dụng nhà bếp", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Thiết bị điện gia dụng lớn", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Máy chiếu & Phụ kiện", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Thiết bị điều khiển từ xa", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Thiết bị điện gia dụng nhỏ", fee: 7.0 }, { l1: "Thiết Bị Điện Gia Dụng", l2: "Tivi & Phụ kiện", fee: 7.0 },
        { l1: "Thể Thao & Dã Ngoại", l2: "Dụng Cụ Thể Thao & Dã Ngoại", fee: 9.0 }, { l1: "Đồng Hồ", l2: "Đồng hồ nam", fee: 9.0 }, { l1: "Đồng Hồ", l2: "Bộ đồng hồ & Đồng hồ cặp", fee: 9.0 }, { l1: "Đồng Hồ", l2: "Đồng hồ nữ", fee: 9.0 }, { l1: "Du lịch & Hành lý", l2: "Vali", fee: 9.0 },
        { l1: "Sức Khỏe", l2: "Thực phẩm chức năng", fee: 9.5 }, { l1: "Sức Khỏe", l2: "Vật tư y tế", fee: 9.5 }, { l1: "Sức Khỏe", l2: "Chăm sóc cá nhân", fee: 9.5 },
        { l1: "Mẹ & Bé", l2: "Đồ dùng du lịch cho bé", fee: 9.0 }, { l1: "Mẹ & Bé", l2: "Đồ dùng ăn dặm cho bé", fee: 9.5 }, { l1: "Mẹ & Bé", l2: "Phụ kiện cho mẹ", fee: 9.5 }, { l1: "Mẹ & Bé", l2: "Chăm sóc sức khỏe mẹ", fee: 9.5 }, { l1: "Mẹ & Bé", l2: "Đồ dùng phòng ngủ cho bé", fee: 9.5 }, { l1: "Mẹ & Bé", l2: "Đồ chơi", fee: 9.5 },
        { l1: "Ô tô", l2: "Ô tô", fee: 4.0 }, { l1: "Nhà cửa & Đời sống", l2: "Dụng cụ & Thiết bị tiện ích", fee: 9.5 }, { l1: "Mô tô, xe máy", l2: "Mô tô, xe máy", fee: 4.0 },
        { l1: "Điện Thoại & Phụ Kiện", l2: "Phụ kiện", fee: 9.0 }, { l1: "Điện Thoại & Phụ Kiện", l2: "Thẻ sim", fee: 9.0 }, { l1: "Điện Thoại & Phụ Kiện", l2: "Bộ đàm", fee: 9.0 }, { l1: "Điện Thoại & Phụ Kiện", l2: "Thiết bị đeo thông minh", fee: 9.0 },
        // Add all Voucher & Dich vu categories with 9.0%
        ...["Sự kiện & Giải trí", "Nhà hàng & Ăn uống", "Mua sắm", "Thanh toán hóa đơn", "Dịch vụ khác", "Sức khỏe & Làm đẹp", "Gọi xe", "Khóa học", "Nạp tiền tài khoản", "Du lịch & Khách sạn", "Tiền điện tử", "Bất động sản", "Thẻ game", "Streaming", "Mã quà tặng Shopee", "Khác"].map(l2 => ({ l1: "Voucher & Dịch vụ", l2: l2, fee: 9.0 })),
        { l1: "Thể Thao & Dã Ngoại", l2: "Phụ Kiện Thể Thao & Dã Ngoại", fee: 10.0 }, { l1: "Thể Thao & Dã Ngoại", l2: "Thời Trang Thể Thao & Dã Ngoại", fee: 10.0 }, { l1: "Thể Thao & Dã Ngoại", l2: "Giày Thể Thao", fee: 10.0 },
        { l1: "Đồng Hồ", l2: "Phụ kiện đồng hồ", fee: 10.0 },
        // Add all Thoi trang tre em categories with 10.0%
        ...["Phụ kiện trẻ em & trẻ sơ sinh", "Quần áo trẻ em", "Bao tay trẻ em & Tất", "Quần áo bé trai", "Giày bé trai", "Quần áo bé gái", "Giày bé gái"].map(l2 => ({ l1: "Thời trang trẻ em & trẻ sơ sinh", l2: l2, fee: 10.0 })),
        // Add all Phu kien thoi trang categories with 10.0%
        ...["Bộ phụ kiện", "Phụ kiện thêm", "Lắc chân", "Thắt lưng", "Vòng tay & Lắc tay", "Bông tai", "Kính mắt", "Găng tay", "Phụ kiện tóc", "Mũ", "Kim loại quý", "Dây chuyền", "Cà vạt & Nơ cổ", "Nhẫn", "Khăn choàng"].map(l2 => ({ l1: "Phụ Kiện Thời Trang", l2: l2, fee: 10.0 })),
        // Add all Tui Vi Nam categories with 10.0%
        ...["Ba lô", "Cặp xách công sở", "Ví cầm tay", "Túi đeo chéo", "Cặp laptop", "Túi tote", "Túi đeo hông & Túi đeo ngực", "Bóp/ Ví"].map(l2 => ({ l1: "Túi Ví Nam", l2: l2, fee: 10.0 })),
        // Add all Thoi Trang Nam categories with 10.0%
        ...["Đồ hóa trang", "Hoodie & Áo nỉ", "Đồ lót", "Áo khoác", "Quần jean", "Trang phục ngành nghề", "Quần dài", "Bộ", "Quần đùi", "Đồ ngủ", "Vớ/ Tất", "Com lê", "Áo len", "Áo", "Trang phục truyền thống"].map(l2 => ({ l1: "Thời Trang Nam", l2: l2, fee: 10.0 })),
        // Add all Giay Dep Nam categories with 10.0%
        ...["Bốt", "Giày tây lười", "Giày Oxfords & Giày buộc dây", "Xăng-đan & Dép", "Phụ kiện giày dép", "Giày sục", "Giày thể thao/ Sneakers"].map(l2 => ({ l1: "Giày Dép Nam", l2: l2, fee: 10.0 })),
        { l1: "Du lịch & Hành lý", l2: "Phụ kiện du lịch", fee: 10.0 }, { l1: "Du lịch & Hành lý", l2: "Túi du lịch", fee: 10.0 },
        // Add all Tui Vi Nu categories with 10.0%
        ...["Ba lô", "Phụ kiện túi", "Ví dự tiệc & Ví cầm tay", "Túi đeo chéo", "Cặp laptop", "Túi quai xách", "Túi tote", "Túi đeo hông & Túi đeo ngực", "Bóp/ Ví"].map(l2 => ({ l1: "Túi Ví Nữ", l2: l2, fee: 10.0 })),
        // Add all Thoi Trang Nu categories with 10.0%
        ...["Đồ hóa trang", "Đầm", "Vải", "Hoodie & Áo nỉ", "Áo khoác", "Quần jean", "Đồ liền thân", "Đồ lót", "Đồ Bầu", "Quần", "Bộ", "Quần đùi", "Váy", "Đồ ngủ", "Vớ/ Tất", "Áo len", "Áo", "Trang phục truyền thống", "Váy cưới"].map(l2 => ({ l1: "Thời Trang Nữ", l2: l2, fee: 10.0 })),
        // Add all Giay Dep Nu categories with 10.0%
        ...["Bốt", "Xăng-đan và dép", "Giày đế bằng", "Giày cao gót", "Phụ kiện giày dép", "Giày thể thao/ Sneakers", "Giày đế xuồng"].map(l2 => ({ l1: "Giày Dép Nữ", l2: l2, fee: 10.0 })),
        // Add all Sac Dep categories with 10.0%
        ...["Tắm & chăm sóc cơ thể", "Bộ sản phẩm làm đẹp", "Dụng cụ làm đẹp", "Chăm sóc tóc", "Chăm sóc tay, chân & móng", "Trang điểm", "Chăm sóc nam giới", "Nước hoa", "Chăm sóc da mặt"].map(l2 => ({ l1: "Sắc Đẹp", l2: l2, fee: 10.0 })),
        { l1: "Sức Khỏe", l2: "Hỗ trợ tình dục", fee: 10.0 },
        // Add all Thuc pham categories with 10.0%
        ...["Đồ uống có cồn", "Các loại bánh", "Đồ làm bánh", "Đồ uống", "Ngũ cốc & mứt", "Đồ chế biến sẵn", "Nguyên liệu nấu ăn", "Sữa - trứng", "Nhu yếu phẩm", "Thực phẩm tươi sống & đông lạnh", "Bộ quà tặng", "Đồ ăn vặt"].map(l2 => ({ l1: "Thực phẩm và đồ uống", l2: l2, fee: 10.0 })),
        // Add all Me & Be categories with 10.0%
        ...["Chăm sóc sức khỏe bé", "An toàn cho bé", "Tắm & chăm sóc cơ thể", "Tã & bô em bé", "Bộ & Gói quà tặng", "Sữa công thức & Thực phẩm cho bé"].map(l2 => ({ l1: "Mẹ & Bé", l2: l2, fee: 10.0 })), // Note: Some Me&Be are 9.5%, this adds the 10% ones
        // Add all Cham Soc Thu Cung categories with 10.0%
        ...["Vệ sinh cho thú cưng", "Phụ kiện cho thú cưng", "Quần áo & phụ kiện", "Thức ăn cho thú cưng", "Làm đẹp cho thú cưng", "Chăm sóc sức khỏe"].map(l2 => ({ l1: "Chăm Sóc Thú Cưng", l2: l2, fee: 10.0 })),
        // Add all O to categories with 10.0%
        ...["Phụ kiện ngoại thất ô tô", "Phụ kiện nội thất ô tô", "Phụ tùng ô tô", "Chăm sóc ô tô", "Móc chìa khóa và Bọc chìa ô tô", "Dầu nhớt và phụ gia ô tô", "Dụng cụ sửa chữa ô tô"].map(l2 => ({ l1: "Ô tô", l2: l2, fee: 10.0 })), // Note: O to base is 4%, this adds the 10% ones
        { l1: "Sách & Tạp Chí", l2: "Sách", fee: 10.0 }, { l1: "Sách & Tạp Chí", l2: "Tạp Chí & Báo Giấy", fee: 10.0 },
        // Add all So thich & Suu tam categories with 10.0%
        ...["Băng - Đĩa", "Đồ Sưu Tầm", "Nhạc Cụ & Phụ Kiện", "Dụng Cụ May Vá", "Album Ảnh", "Quà Lưu Niệm", "Đồ chơi - Giải trí", "Đĩa Than"].map(l2 => ({ l1: "Sở thích & Sưu tầm", l2: l2, fee: 10.0 })),
        // Add all Nha cua & Doi song categories with 10.0%
        ...["Đồ dùng phòng tắm", "Chăn ga gối nệm", "Trang trí nhà cửa", "Bộ đồ bàn ăn", "Đồ thờ cúng, đồ phong thủy", "Nội thất", "Làm vườn", "Túi làm ấm", "Dụng cụ chăm sóc nhà cửa", "Chất khử mùi, làm thơm nhà", "Sắp xếp nhà cửa", "Dụng cụ nhà bếp", "Đèn", "Trang trí tiệc tùng", "Bảo hộ gia đình"].map(l2 => ({ l1: "Nhà cửa & Đời sống", l2: l2, fee: 10.0 })), // Note: Some are 9.5%, this adds the 10% ones
        // Add all Mo to, xe may categories with 10.0%
        ...["Phụ kiện xe máy", "Mũ bảo hiểm & Phụ kiện", "Phụ tùng xe máy"].map(l2 => ({ l1: "Mô tô, xe máy", l2: l2, fee: 10.0 })), // Note: Base is 4%, this adds the 10% ones
        // Add all Van Phong Pham categories with 10.0%
        ...["Họa cụ", "Quà Tặng - Giấy Gói", "Thư Tín", "Sổ & Giấy Các Loại", "Thiết Bị Trường Học", "Bút Các Loại"].map(l2 => ({ l1: "Văn Phòng Phẩm", l2: l2, fee: 10.0 }))
    ];


    // --- Input Elements (Get references AFTER the elements exist) ---
    const giaNhapInput = document.getElementById('giaNhap');
    const giaBanInput = document.getElementById('giaBan');
    const nganhHangL1Select = document.getElementById('nganhHangL1');
    const nganhHangL2Select = document.getElementById('nganhHangL2');
    const phiCoDinhDisplay = document.getElementById('phiCoDinhDisplay');
    const tyLePhiThanhToanInput = document.getElementById('tyLePhiThanhToan');
    const tyLeThueInput = document.getElementById('tyLeThue');
    const isMallCheckbox = document.getElementById('isMall');
    const tyLePhiMallInput = document.getElementById('tyLePhiMall');
    const phanTramQuangCaoInput = document.getElementById('phanTramQuangCao');
    const phanTramAffiliateInput = document.getElementById('phanTramAffiliate');
    const phanTramVoucherInput = document.getElementById('phanTramVoucher');
    const phanTramMktKhacInput = document.getElementById('phanTramMktKhac');
    const tyLeVanHanhInput = document.getElementById('tyLeVanHanh');
    const tyLeBatThuongInput = document.getElementById('tyLeBatThuong');
    const useFreeshipXtraCheckbox = document.getElementById('useFreeshipXtra');
    const useVoucherXtraCheckbox = document.getElementById('useVoucherXtra');
    const chiPhiDongGoiInput = document.getElementById('chiPhiDongGoi');
    const chiPhiMktCoDinhInput = document.getElementById('chiPhiMktCoDinh');
    const tyLeHoanInput = document.getElementById('tyLeHoan');
    const chiPhiXuLyHoanInput = document.getElementById('chiPhiXuLyHoan');
    const tinhToanBtn = document.getElementById('tinhToanBtn');
    const ketQuaTrucTiepDiv = document.getElementById('ketQuaTrucTiep');

    // --- Error Elements ---
    const errorGiaNhap = document.getElementById('errorGiaNhap');
    const errorGiaBan = document.getElementById('errorGiaBan');
    const errorNganhHangL1 = document.getElementById('errorNganhHangL1');
    const errorNganhHangL2 = document.getElementById('errorNganhHangL2');
    // const errorPhiCoDinh = document.getElementById('errorPhiCoDinh'); // Removed input
    const errorPhiThanhToan = document.getElementById('errorPhiThanhToan');
    const errorThue = document.getElementById('errorThue');
    const errorPhiMall = document.getElementById('errorPhiMall');
    const errorQuangCao = document.getElementById('errorQuangCao');
    const errorAffiliate = document.getElementById('errorAffiliate');
    const errorVoucher = document.getElementById('errorVoucher');
    const errorMktKhac = document.getElementById('errorMktKhac');
    const errorVanHanh = document.getElementById('errorVanHanh');
    const errorBatThuong = document.getElementById('errorBatThuong');
    const errorDongGoi = document.getElementById('errorDongGoi');
    const errorMktCoDinh = document.getElementById('errorMktCoDinh');
    const errorTyLeHoan = document.getElementById('errorTyLeHoan');
    const errorXuLyHoan = document.getElementById('errorXuLyHoan');

    // --- Constants ---
    const TYLE_VAT_QUANG_CAO = 0.10;
    const TYLE_FREESHIP_XTRA = 0.08;
    const MAX_PHI_FREESHIP_XTRA = 30000;
    const TYLE_VOUCHER_XTRA = 0.05;
    const MAX_PHI_VOUCHER_XTRA = 20000;

    // --- Helper Functions ---
    function formatCurrency(value) { /* ... */ }
    function clearErrors() { /* ... */ }
    function validateInput(inputElement, errorElement, message, allowZero = false, isPositive = false) { /* ... */ }
    function validateSelect(selectElement, errorElement, message) {
        let isValid = true;
        if (selectElement.value === "") {
            errorElement.textContent = message;
            isValid = false;
        }
        return isValid;
    }

    // Update these helpers
     function formatCurrency(value) {
        const numValue = Number(value);
        if (isNaN(numValue)) { return 'Lỗi'; }
        return Math.round(numValue).toLocaleString('vi-VN');
    }

    function clearErrors() {
        const errorElements = document.querySelectorAll('.error');
        errorElements.forEach(el => el.textContent = '');
    }

     function validateInput(inputElement, errorElement, message, allowZero = false, isPositive = false) {
        if (inputElement.disabled) { errorElement.textContent = ''; return true; }
        const valueStr = inputElement.value.trim();
        const valueNum = parseFloat(valueStr);
        let isValid = true;
        if (valueStr === '') { errorElement.textContent = 'Vui lòng nhập giá trị.'; isValid = false;
        } else if (isNaN(valueNum)) { errorElement.textContent = 'Vui lòng nhập số hợp lệ.'; isValid = false;
        } else if (valueNum < 0) { errorElement.textContent = message + ' không được âm.'; isValid = false;
        } else if (isPositive && valueNum <= 0) { errorElement.textContent = message + ' phải là số dương.'; isValid = false; }
        if (valueNum === 0 && valueStr !== '0' && valueStr !== '' && isNaN(parseFloat(valueStr))) { errorElement.textContent = 'Vui lòng nhập số hợp lệ.'; isValid = false; }
        return isValid;
    }


    // --- Populate Dropdowns ---
    function populateL1Dropdown() {
        const l1Categories = [...new Set(categoryData.map(item => item.l1))].sort();
        l1Categories.forEach(l1 => {
            const option = document.createElement('option');
            option.value = l1;
            option.textContent = l1;
            nganhHangL1Select.appendChild(option);
        });
    }

    function updateL2Dropdown() {
        const selectedL1 = nganhHangL1Select.value;
        nganhHangL2Select.innerHTML = '<option value="">-- Chọn Cấp 2 --</option>'; // Reset L2
        phiCoDinhDisplay.textContent = "Chưa chọn ngành hàng"; // Reset display
        nganhHangL2Select.disabled = true;
         errorNganhHangL1.textContent = ''; // Clear L1 error on change
         errorNganhHangL2.textContent = ''; // Clear L2 error on change


        if (selectedL1) {
            const l2Categories = categoryData
                .filter(item => item.l1 === selectedL1)
                .map(item => item.l2)
                .sort();

            if (l2Categories.length > 0) {
                 l2Categories.forEach(l2 => {
                    const option = document.createElement('option');
                    option.value = l2;
                    option.textContent = l2;
                    nganhHangL2Select.appendChild(option);
                });
                nganhHangL2Select.disabled = false;
            } else {
                 // Handle cases where L1 might not have specific L2 in data (though unlikely with full list)
                 phiCoDinhDisplay.textContent = "Không có Cấp 2 cho ngành này";
            }
        }
        // Trigger calculation after updating L2 options (optional, might be better on L2 change)
        // tinhLoiNhuan();
    }

     function updateFeeDisplay() {
        const selectedL1 = nganhHangL1Select.value;
        const selectedL2 = nganhHangL2Select.value;
         errorNganhHangL2.textContent = ''; // Clear L2 error on change

        if (selectedL1 && selectedL2) {
            const category = categoryData.find(item => item.l1 === selectedL1 && item.l2 === selectedL2);
            if (category) {
                phiCoDinhDisplay.textContent = `${category.fee.toFixed(1)}%`; // Display fee
                 // Trigger calculation whenever L2 changes and fee is found
                 tinhLoiNhuan();
            } else {
                phiCoDinhDisplay.textContent = "Lỗi tìm phí"; // Should not happen if data is correct
            }
        } else {
             phiCoDinhDisplay.textContent = "Chưa chọn ngành hàng";
        }
    }


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', populateL1Dropdown); // Populate L1 on load
    nganhHangL1Select.addEventListener('change', updateL2Dropdown);
    nganhHangL2Select.addEventListener('change', updateFeeDisplay);

    isMallCheckbox.addEventListener('change', function() {
        tyLePhiMallInput.disabled = !this.checked;
        if (!this.checked) { errorPhiMall.textContent = ''; }
         tinhLoiNhuan(); // Recalculate when Mall status changes
    });
     // Add listeners for Shopee program checkboxes to recalculate
    useFreeshipXtraCheckbox.addEventListener('change', tinhLoiNhuan);
    useVoucherXtraCheckbox.addEventListener('change', tinhLoiNhuan);


    // --- Main Calculation Function ---
    function tinhLoiNhuan() {
        // 1. Clear previous state
        clearErrors();
        ketQuaTrucTiepDiv.innerHTML = '';
        ketQuaTrucTiepDiv.className = '';

        // 2. Validate ALL Inputs (including selects)
        let formIsValid = true;
        formIsValid &= validateInput(giaNhapInput, errorGiaNhap, "Giá nhập", true);
        formIsValid &= validateInput(giaBanInput, errorGiaBan, "Giá bán", false, true);
        // Validate Category Selection
        formIsValid &= validateSelect(nganhHangL1Select, errorNganhHangL1, "Vui lòng chọn ngành hàng Cấp 1.");
        formIsValid &= validateSelect(nganhHangL2Select, errorNganhHangL2, "Vui lòng chọn ngành hàng Cấp 2.");
        // Other validations...
        formIsValid &= validateInput(tyLePhiThanhToanInput, errorPhiThanhToan, "% Phí thanh toán", true);
        formIsValid &= validateInput(tyLeThueInput, errorThue, "% Thuế", true);
        if (isMallCheckbox.checked) { formIsValid &= validateInput(tyLePhiMallInput, errorPhiMall, "% Phí Mall", true); }
        formIsValid &= validateInput(phanTramQuangCaoInput, errorQuangCao, "% Quảng cáo Shopee", true);
        formIsValid &= validateInput(phanTramAffiliateInput, errorAffiliate, "% Affiliate", true);
        formIsValid &= validateInput(phanTramVoucherInput, errorVoucher, "% Voucher/KM", true);
        formIsValid &= validateInput(phanTramMktKhacInput, errorMktKhac, "% MKT khác", true);
        formIsValid &= validateInput(tyLeVanHanhInput, errorVanHanh, "% Vận Hành", true);
        formIsValid &= validateInput(tyLeBatThuongInput, errorBatThuong, "% Bất Thường", true);
        formIsValid &= validateInput(chiPhiDongGoiInput, errorDongGoi, "Chi phí đóng gói", true);
        formIsValid &= validateInput(chiPhiMktCoDinhInput, errorMktCoDinh, "Chi phí MKT cố định", true);
        formIsValid &= validateInput(tyLeHoanInput, errorTyLeHoan, "% Tỷ lệ hoàn", true);
        formIsValid &= validateInput(chiPhiXuLyHoanInput, errorXuLyHoan, "Chi phí xử lý hoàn", true);

        if (!formIsValid) {
             ketQuaTrucTiepDiv.textContent = 'Vui lòng kiểm tra lại các ô nhập liệu.';
             ketQuaTrucTiepDiv.classList.add('result-negative');
            return;
        }

        // 3. Get Validated Values
        const giaNhap = parseFloat(giaNhapInput.value) || 0;
        const giaBan = parseFloat(giaBanInput.value) || 0;
        // --- Get Fixed Fee from selected category ---
        const selectedL1 = nganhHangL1Select.value;
        const selectedL2 = nganhHangL2Select.value;
        const categoryInfo = categoryData.find(item => item.l1 === selectedL1 && item.l2 === selectedL2);
        const tyLePhiCoDinh = categoryInfo ? (categoryInfo.fee / 100) : 0; // Get fee based on selection
        // --- End Get Fixed Fee ---
        const tyLePhiThanhToan = (parseFloat(tyLePhiThanhToanInput.value) || 0) / 100;
        const tyLeThue = (parseFloat(tyLeThueInput.value) || 0) / 100;
        const tyLePhiMall = (isMallCheckbox.checked ? (parseFloat(tyLePhiMallInput.value) || 0) : 0) / 100;
        const phanTramQuangCao = (parseFloat(phanTramQuangCaoInput.value) || 0) / 100;
        const phanTramAffiliate = (parseFloat(phanTramAffiliateInput.value) || 0) / 100;
        const phanTramVoucher = (parseFloat(phanTramVoucherInput.value) || 0) / 100;
        const phanTramMktKhac = (parseFloat(phanTramMktKhacInput.value) || 0) / 100;
        const tyLeVanHanh = (parseFloat(tyLeVanHanhInput.value) || 0) / 100;
        const tyLeBatThuong = (parseFloat(tyLeBatThuongInput.value) || 0) / 100;
        const useFSX = useFreeshipXtraCheckbox.checked;
        const useVX = useVoucherXtraCheckbox.checked;
        const chiPhiDongGoi = parseFloat(chiPhiDongGoiInput.value) || 0;
        const chiPhiMktCoDinh = parseFloat(chiPhiMktCoDinhInput.value) || 0;
        const tyLeHoan = (parseFloat(tyLeHoanInput.value) || 0) / 100;
        const chiPhiXuLyHoan = parseFloat(chiPhiXuLyHoanInput.value) || 0;

        // --- Calculations ---
        // 4. Percentage-Based Costs (on giaBan)
        const cpPhiCoDinh = giaBan * tyLePhiCoDinh; // Use category-based fee
        const cpPhiThanhToan = giaBan * tyLePhiThanhToan;
        const cpThue = giaBan * tyLeThue;
        const cpPhiMall = giaBan * tyLePhiMall;
        const cpQuangCao = giaBan * phanTramQuangCao;
        const cpVatQuangCao = cpQuangCao * TYLE_VAT_QUANG_CAO;
        const cpAffiliate = giaBan * phanTramAffiliate;
        const cpVoucher = giaBan * phanTramVoucher;
        const cpMktKhacPercent = giaBan * phanTramMktKhac;
        const cpVanHanh = giaBan * tyLeVanHanh;
        const cpBatThuong = giaBan * tyLeBatThuong;

        // 5. Shopee Program Costs (with Caps)
        let cpFSX = 0; if (useFSX) { cpFSX = Math.min(giaBan * TYLE_FREESHIP_XTRA, MAX_PHI_FREESHIP_XTRA); }
        let cpVX = 0; if (useVX) { cpVX = Math.min(giaBan * TYLE_VOUCHER_XTRA, MAX_PHI_VOUCHER_XTRA); }

        // 6. Fixed Costs per Order
        const cpDongGoi = chiPhiDongGoi;
        const cpMktCoDinh = chiPhiMktCoDinh;

        // 7. Average Return Cost per *Sold* Order
        const cpHoanTrungBinh = tyLeHoan * chiPhiXuLyHoan;

        // 8. Total Costs (excluding cost price)
        const tongChiPhiTruGiaNhap = cpPhiCoDinh + cpPhiThanhToan + cpThue + cpPhiMall + cpQuangCao + cpVatQuangCao + cpAffiliate + cpVoucher + cpMktKhacPercent + cpVanHanh + cpBatThuong + cpFSX + cpVX + cpDongGoi + cpMktCoDinh + cpHoanTrungBinh;
        const tongChiPhiBaoGomGiaGoc = tongChiPhiTruGiaNhap + giaNhap;

        // 9. Calculate Profit
        const loiNhuan = giaBan - tongChiPhiBaoGomGiaGoc;

        // 10. Prepare and Display Result
        let resultHTML = ''; let resultClass = ''; let colorClass = '';
        if (loiNhuan > 0) { resultClass = 'result-positive'; colorClass = 'positive'; resultHTML = `Lợi nhuận ước tính: <span class="${colorClass}">${formatCurrency(loiNhuan)}</span> VNĐ`;
        } else if (loiNhuan < 0) { resultClass = 'result-negative'; colorClass = 'negative'; resultHTML = `Lỗ ước tính: <span class="${colorClass}">${formatCurrency(loiNhuan)}</span> VNĐ`;
        } else { resultClass = 'result-zero'; colorClass = 'zero'; resultHTML = `Hòa vốn ước tính: <span class="${colorClass}">${formatCurrency(loiNhuan)}</span> VNĐ`; }
        resultHTML += `<br><small style="color: var(--text-color-light); font-size: 0.9em;">(Tổng chi phí/đơn: ${formatCurrency(tongChiPhiBaoGomGiaGoc)} VNĐ | Phí cố định: ${ (tyLePhiCoDinh * 100).toFixed(1) }%)</small>`; // Show applied fixed fee %

        ketQuaTrucTiepDiv.classList.add(resultClass);
        ketQuaTrucTiepDiv.innerHTML = resultHTML;
    }

    // --- Attach Event Listeners ---
    tinhToanBtn.addEventListener('click', tinhLoiNhuan);
    const allInputsAndSelects = document.querySelectorAll('input[type="number"], input[type="checkbox"], select'); // Include selects
    allInputsAndSelects.forEach(input => {
         if(input.type === 'number') { input.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); tinhToanBtn.click(); } }); }
         // Optional: Recalculate on change for immediate feedback (can be slow)
         // input.addEventListener('input', tinhLoiNhuan); // Number inputs
         // input.addEventListener('change', tinhLoiNhuan); // Checkboxes and Selects
    });

</script>

</body>
</html>
